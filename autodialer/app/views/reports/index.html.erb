<div class="w-full space-y-6">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <div>
      <%= link_to calls_path, class: "inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-4 transition" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Dashboard
      <% end %>
      <h1 class="text-2xl font-semibold text-gray-900">Reports & Analytics</h1>
      <p class="text-sm text-gray-500 mt-1">Detailed cost tracking and billing reports</p>
    </div>
    <div class="flex gap-3">
      <%= link_to reports_export_path(date_range: @date_range), class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Export Report
      <% end %>
      <%= link_to reports_cost_analysis_path, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        Cost Analysis
      <% end %>
    </div>
  </div>

  <!-- Date Range Selector -->
  <div class="bg-white border border-gray-200 rounded-lg p-5">
    <%= form_with url: reports_path, method: :get, class: "flex flex-wrap gap-4 items-end" do |f| %>
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
        <%= f.select :date_range, 
            options_for_select([
              ['Today', 'today'],
              ['Yesterday', 'yesterday'],
              ['Last 7 Days', 'last_7_days'],
              ['Last 30 Days', 'last_30_days'],
              ['This Month', 'this_month'],
              ['Last Month', 'last_month'],
              ['Custom', 'custom']
            ], @date_range),
            {},
            class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500",
            onchange: "this.form.submit()" %>
      </div>
      
      <div class="flex-1 min-w-[200px]" id="custom-dates" style="<%= @date_range == 'custom' ? '' : 'display:none;' %>">
        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
        <%= f.date_field :start_date, value: @start_date.strftime('%Y-%m-%d'), class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" %>
      </div>
      
      <div class="flex-1 min-w-[200px]" id="custom-dates-end" style="<%= @date_range == 'custom' ? '' : 'display:none;' %>">
        <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
        <%= f.date_field :end_date, value: @end_date.strftime('%Y-%m-%d'), class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" %>
      </div>
      
      <%= f.submit "Apply", class: "px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition cursor-pointer" %>
    <% end %>
  </div>

  <!-- Summary Statistics -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bg-white border border-gray-200 rounded-lg p-5">
      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Total Calls</p>
      <p class="text-2xl font-semibold text-gray-900 mt-2"><%= @total_calls %></p>
      <p class="text-xs text-gray-500 mt-1">
        <%= @completed_calls %> completed, <%= @failed_calls %> failed
      </p>
    </div>

    <div class="bg-white border border-gray-200 rounded-lg p-5">
      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Total Duration</p>
      <p class="text-2xl font-semibold text-gray-900 mt-2"><%= (@total_duration / 60.0).round(1) %> min</p>
      <p class="text-xs text-gray-500 mt-1">
        Avg: <%= @avg_duration %> seconds per call
      </p>
    </div>

    <div class="bg-white border border-gray-200 rounded-lg p-5">
      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Total Cost</p>
      <p class="text-2xl font-semibold text-gray-900 mt-2">$<%= number_with_precision(@total_cost, precision: 2) %></p>
      <p class="text-xs text-gray-500 mt-1">
        Avg: $<%= @avg_cost_per_call %> per call
      </p>
    </div>

    <div class="bg-white border border-gray-200 rounded-lg p-5">
      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Success Rate</p>
      <p class="text-2xl font-semibold text-green-600 mt-2"><%= @success_rate %>%</p>
      <p class="text-xs text-gray-500 mt-1">
        <%= @completed_calls %> of <%= @total_calls %> calls
      </p>
    </div>
  </div>

  <!-- Daily Breakdown -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Daily Breakdown</h2>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Calls</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration (min)</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Success Rate</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @daily_stats.each do |stat| %>
            <tr class="hover:bg-gray-50 transition">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= stat.date.strftime('%Y-%m-%d') %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= stat.total_calls %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">
                <%= stat.completed_calls %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= ((stat.total_duration || 0) / 60.0).round(1) %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                $<%= number_with_precision(stat.total_cost || 0, precision: 2) %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <% success_rate = stat.total_calls > 0 ? ((stat.completed_calls.to_f / stat.total_calls) * 100).round(1) : 0 %>
                <span class="<%= success_rate >= 80 ? 'text-green-600' : success_rate >= 50 ? 'text-yellow-600' : 'text-red-600' %>">
                  <%= success_rate %>%
                </span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Campaign Breakdown -->
  <% if @campaign_stats.any? %>
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Campaign Performance</h2>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaign</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Calls</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Cost</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Success Rate</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @campaign_stats.each do |stat| %>
              <tr class="hover:bg-gray-50 transition">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  <%= stat.campaign_id %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= stat.call_count %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">
                  <%= stat.completed_count %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  $<%= number_with_precision(stat.total_cost || 0, precision: 2) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <% success_rate = stat.call_count > 0 ? ((stat.completed_count.to_f / stat.call_count) * 100).round(1) : 0 %>
                  <span class="<%= success_rate >= 80 ? 'text-green-600' : success_rate >= 50 ? 'text-yellow-600' : 'text-red-600' %>">
                    <%= success_rate %>%
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <!-- Top Contacts -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Top Contacts by Call Volume</h2>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone Number</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Call Count</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Cost</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @top_contacts.each do |contact| %>
            <tr class="hover:bg-gray-50 transition">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                <%= contact.name || 'Unknown' %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                <%= contact.phone_number %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= contact.call_count %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                $<%= number_with_precision(contact.total_cost || 0, precision: 2) %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Show/hide custom date fields
  document.querySelector('select[name="date_range"]').addEventListener('change', function() {
    const customDates = document.getElementById('custom-dates');
    const customDatesEnd = document.getElementById('custom-dates-end');
    if (this.value === 'custom') {
      customDates.style.display = 'block';
      customDatesEnd.style.display = 'block';
    } else {
      customDates.style.display = 'none';
      customDatesEnd.style.display = 'none';
    }
  });
</script>
